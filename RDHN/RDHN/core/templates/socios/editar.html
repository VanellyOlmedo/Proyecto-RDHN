{% extends 'core/base.html' %}

{% block title %}Editar Socio - Sistema de Gesti√≥n{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="content-title">üë• Editar Socio</h1>
    <div class="breadcrumb">
        <span class="breadcrumb-item"><a href="{% url 'core:socios_listar' %}">Socios</a></span>
        <span class="breadcrumb-item"><a href="{% url 'core:socios_detalle' socio.pk %}">{{ socio.nombre_completo }}</a></span>
        <span class="breadcrumb-item">Editar</span>
    </div>
</div>

<div class="card" style="max-width: 900px; margin: 0 auto;">
    <div class="card-header">
        <h2 class="card-title">Editar: {{ socio.nombre_completo }}</h2>
    </div>
    
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            
            <div class="grid grid-2">
                <div class="form-group">
                    <label class="form-label">
                        N√∫mero de Socio 
                        <span style="color: var(--color-success); font-size: 12px;">‚óè</span>
                    </label>
                    {{ form.numero_socio }}
                    {% if form.numero_socio.errors %}
                        <span style="color: var(--color-error); font-size: 12px;">{{ form.numero_socio.errors.0 }}</span>
                    {% endif %}
                    <small style="color: var(--color-text-dim);">No se puede modificar</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Identidad</label>
                    {{ form.identidad }}
                    {% if form.identidad.errors %}
                        <span style="color: var(--color-error); font-size: 12px;">{{ form.identidad.errors.0 }}</span>
                    {% endif %}
                    <small style="color: var(--color-text-dim);">Formato: 0801-1990-12345</small>
                </div>
            </div>
            
            <div class="grid grid-2">
                <div class="form-group">
                    <label class="form-label">Primer Nombre</label>
                    {{ form.primer_nombre }}
                    {% if form.primer_nombre.errors %}
                        <span style="color: var(--color-error); font-size: 12px;">{{ form.primer_nombre.errors.0 }}</span>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label class="form-label">Segundo Nombre</label>
                    {{ form.segundo_nombre }}
                    {% if form.segundo_nombre.errors %}
                        <span style="color: var(--color-error); font-size: 12px;">{{ form.segundo_nombre.errors.0 }}</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="grid grid-2">
                <div class="form-group">
                    <label class="form-label">Primer Apellido</label>
                    {{ form.primer_apellido }}
                    {% if form.primer_apellido.errors %}
                        <span style="color: var(--color-error); font-size: 12px;">{{ form.primer_apellido.errors.0 }}</span>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label class="form-label">Segundo Apellido</label>
                    {{ form.segundo_apellido }}
                    {% if form.segundo_apellido.errors %}
                        <span style="color: var(--color-error); font-size: 12px;">{{ form.segundo_apellido.errors.0 }}</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Direcci√≥n</label>
                {{ form.direccion }}
                {% if form.direccion.errors %}
                    <span style="color: var(--color-error); font-size: 12px;">{{ form.direccion.errors.0 }}</span>
                {% endif %}
            </div>
            
            <div class="grid grid-2">
                <div class="form-group">
                    <label class="form-label">Fecha de Ingreso</label>
                    {{ form.fecha_ingreso }}
                    {% if form.fecha_ingreso.errors %}
                        <span style="color: var(--color-error); font-size: 12px;">{{ form.fecha_ingreso.errors.0 }}</span>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label class="form-label">Fecha de Egreso</label>
                    {{ form.fecha_egreso }}
                    {% if form.fecha_egreso.errors %}
                        <span style="color: var(--color-error); font-size: 12px;">{{ form.fecha_egreso.errors.0 }}</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Estado</label>
                {{ form.id_estado }}
                {% if form.id_estado.errors %}
                    <span style="color: var(--color-error); font-size: 12px;">{{ form.id_estado.errors.0 }}</span>
                {% endif %}
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button type="submit" class="btn btn-primary">
                    <span>üíæ</span> Actualizar
                </button>
                <a href="{% url 'core:socios_detalle' socio.pk %}" class="btn">
                    <span>‚ùå</span> Cancelar
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const identidadInput = document.querySelector('.identidad-input');
    
    if (identidadInput) {
        // Guardar el valor original al cargar
        const valorOriginal = identidadInput.value;
        const valorOriginalLimpio = valorOriginal.replace(/\D/g, '');
        
        // Flag para saber si el campo ha sido modificado
        let campoModificado = false;
        
        // Si el valor original tiene m√°s de 13 d√≠gitos, no formatear inicialmente
        const debeFormatearInicial = valorOriginalLimpio.length === 0 || valorOriginalLimpio.length <= 13;
        
        if (debeFormatearInicial && valorOriginalLimpio.length > 0) {
            // Solo formatear si tiene 13 d√≠gitos o menos
            let formattedValue = '';
            if (valorOriginalLimpio.length > 0) {
                formattedValue = valorOriginalLimpio.substring(0, 4);
            }
            if (valorOriginalLimpio.length > 4) {
                formattedValue += '-' + valorOriginalLimpio.substring(4, 8);
            }
            if (valorOriginalLimpio.length > 8) {
                formattedValue += '-' + valorOriginalLimpio.substring(8, 13);
            }
            identidadInput.value = formattedValue;
        }
        
        // Detectar cuando el usuario comienza a editar
        identidadInput.addEventListener('focus', function() {
            campoModificado = true;
        });
        
        // Formatear mientras el usuario escribe (solo si est√° modificando)
        identidadInput.addEventListener('input', function(e) {
            if (!campoModificado) {
                campoModificado = true;
            }
            
            let value = e.target.value.replace(/\D/g, ''); // Solo n√∫meros
            
            // Si est√° vac√≠o o el usuario est√° escribiendo, aplicar formato
            let formattedValue = '';
            
            // Aplicar formato xxxx-xxxx-xxxxx
            if (value.length > 0) {
                formattedValue = value.substring(0, 4);
            }
            if (value.length > 4) {
                formattedValue += '-' + value.substring(4, 8);
            }
            if (value.length > 8) {
                formattedValue += '-' + value.substring(8, 13);
            }
            
            e.target.value = formattedValue;
        });
        
        // Cuando pierde el foco, validar
        identidadInput.addEventListener('blur', function(e) {
            const value = e.target.value.replace(/\D/g, '');
            
            // Si el campo fue modificado y tiene contenido, asegurar formato correcto
            if (campoModificado && value.length > 0 && value.length <= 13) {
                let formattedValue = '';
                if (value.length > 0) {
                    formattedValue = value.substring(0, 4);
                }
                if (value.length > 4) {
                    formattedValue += '-' + value.substring(4, 8);
                }
                if (value.length > 8) {
                    formattedValue += '-' + value.substring(8, 13);
                }
                e.target.value = formattedValue;
            }
        });
    }
});
</script>
{% endblock %}